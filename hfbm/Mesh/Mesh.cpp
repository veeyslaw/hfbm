#include "Mesh.h"
#include <fstream>
#include <glm.hpp>
#include <gtx/normal.hpp>

#define STL_HEADER_LENGTH 80

Mesh::Mesh(const std::vector<glm::fvec3>& points, const std::vector<TriangleIndices>& triangleIndices) :
	triangleIndices(triangleIndices),
	noOfVertices(points.size()),
	noOfTriangles(triangleIndices.size()) {

	vertices.reserve(noOfVertices);
	for (auto i = 0; i < noOfVertices; i++) {
		vertices.push_back(Vertex(points.at(i)));
	}
}

void writeHeader(std::ofstream& fileStream)
{
	std::string header("STL generated by hfbm");
	header.reserve(STL_HEADER_LENGTH);
	header.insert(header.size(), STL_HEADER_LENGTH - header.size(), ' ');

	fileStream.write(header.c_str(), STL_HEADER_LENGTH);
}

void writeVector(std::ofstream& ofs, const glm::fvec3& vector) {
	ofs.write(reinterpret_cast<const char*>(&vector[0]), sizeof vector[0]);
	ofs.write(reinterpret_cast<const char*>(&vector[1]), sizeof vector[1]);
	ofs.write(reinterpret_cast<const char*>(&vector[2]), sizeof vector[2]);
}

void Mesh::writeTriangleData(std::ofstream& fileStream) const
{
	// This field will not be used
	static const std::uint16_t attribByteCount = 0;

	for (auto i = 0; i < noOfTriangles; i++) {
		auto indices = triangleIndices.at(i);

		auto vertex1 = vertices.at(indices.points.at(0)).position;
		auto vertex2 = vertices.at(indices.points.at(1)).position;
		auto vertex3 = vertices.at(indices.points.at(2)).position;

		auto normal = glm::triangleNormal(vertex1, vertex2, vertex3);

		writeVector(fileStream, normal);
		writeVector(fileStream, vertex1);
		writeVector(fileStream, vertex2);
		writeVector(fileStream, vertex3);

		fileStream.write(reinterpret_cast<const char*>(&attribByteCount), sizeof attribByteCount);
	}
}

void Mesh::saveToSTL(const std::string& path) const {
	std::ofstream fileStream(path, std::ios_base::out | std::ios::binary);
	if (!fileStream.is_open()) {
		// TODO handle error
		return;
	}
	
	writeHeader(fileStream);

	auto noOfTriangles = getNoOfTriangles();
	fileStream.write(reinterpret_cast<const char*>(&noOfTriangles), sizeof noOfTriangles);

	writeTriangleData(fileStream);
}